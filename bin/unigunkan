#!/usr/bin/env ruby
# encoding: UTF-8

require 'fileutils'
require 'pathname'
require 'optparse'
require 'unigunkan'
opt = OptionParser.new

OPTS = {}
opt.on('-y') {|v| OPTS[:y] = v }
opt.on('--disable-retina-4inch-support') {|v| OPTS[:disable_retina_4inch_support] = v}
opt.parse!(ARGV)

input = ARGV[0]
backup_confirmed = OPTS[:y]
disable_retina_4inch_support = OPTS[:disable_retina_4inch_support]

if input.nil?
  STDERR.puts "No input file."
  exit false
end

puts "Hello Uni. #{ARGV[0]}"

input = "#{input}/project.pbxproj" if !File.exists?(input) || File::ftype(input) == "directory"

if !File.exists?(input)
  STDERR.puts "Xcode project file not found in #{ARGV[0]}."
  exit false
end

if backup_confirmed != true
  STDERR.puts "Caution: Project file might be broken using this script."
  STDERR.puts "This script makes a copy of original project.pbxproj as project.pbxproj.backup{date}."
  STDERR.puts "If the project was broken, delete project.pbxproj and restore from a backup."
  STDERR.puts " "
  STDERR.puts "OK? Then append '-y' and run again. `unigunkan #{ARGV.join(' ')} -y`"
  exit false
end

processor = Unigunkan::Processor.new(input, OPTS)
processor.create_backup

# read the original
src = ""
f = open(input)
src = f.read
f.close

# Disable iphone5 support
# (Remove lines which include 'Default-568h@2x.png'.)
if disable_retina_4inch_support
  src = processor.disable_retina_4inch_support(src)
end

# delete the original
FileUtils.rm input

# write to project.pbxproj
open(input, "w") {|f|
  f.puts src
}